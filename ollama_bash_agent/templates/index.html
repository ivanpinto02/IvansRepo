<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Bash Agent GUI</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fira Mono', monospace;
            background: linear-gradient(135deg, #181c2b 0%, #232a3e 100%);
            color: #e0e6f0;
            margin: 0; padding: 0;
            min-height: 100vh;
            display: flex; flex-direction: column;
        }
        .container {
            max-width: 500px;
            margin: 48px auto 24px auto;
            background: rgba(35, 38, 60, 0.98);
            border-radius: 18px;
            box-shadow: 0 8px 40px #000b, 0 1.5px 0 #8aff80 inset;
            padding: 36px 36px 28px 36px;
        }
        .logo {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
        }
        .logo-icon {
            width: 54px; height: 54px;
            border-radius: 12px;
            background: linear-gradient(135deg, #8aff80 30%, #80c2ff 100%);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.2em; color: #232323; font-weight: bold;
            box-shadow: 0 2px 12px #8aff8055;
        }
        h1 {
            text-align: center;
            font-size: 2.1em;
            font-weight: 700;
            letter-spacing: 1.5px;
            color: #8aff80;
            margin-bottom: 18px;
        }
        form {
            display: flex; flex-direction: column; gap: 14px;
        }
        .spinner {
            display: none;
            margin: 16px auto 0 auto;
            border: 6px solid #232a3e;
            border-top: 6px solid #8aff80;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        input[type="text"] {
            padding: 13px 14px;
            border-radius: 7px;
            border: 1.5px solid #3d465a;
            background: #232a3e;
            color: #e0e6f0;
            font-size: 1.1em;
            outline: none;
            transition: border 0.2s;
        }
        input[type="text"]:focus {
            border: 1.5px solid #8aff80;
        }
        button {
            padding: 12px;
            background: linear-gradient(90deg, #8aff80 60%, #80c2ff 100%);
            color: #232323;
            border: none;
            border-radius: 7px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s;
            box-shadow: 0 2px 8px #8aff8033;
        }
        button:hover {
            background: linear-gradient(90deg, #80c2ff 20%, #8aff80 100%);
            box-shadow: 0 4px 18px #80c2ff44;
        }
        .output, .command {
            background: #191e2d;
            padding: 18px;
            border-radius: 8px;
            margin-top: 22px;
            font-size: 1.1em;
            white-space: pre-wrap;
            box-shadow: 0 1px 8px #0004;
        }
        .command {
            color: #80c2ff;
            margin-bottom: 10px;
            border-left: 4px solid #80c2ff;
            background: #181f2e;
        }
        .output {
            color: #8aff80;
            border-left: 4px solid #8aff80;
        }
        .flash {
            color: #ff8080;
            margin-bottom: 14px;
            text-align: center;
            font-weight: bold;
        }
        footer {
            text-align: center;
            color: #6b7687;
            font-size: 0.97em;
            margin: 0 0 18px 0;
            letter-spacing: 0.2px;
        }
        @media (max-width: 600px) {
            .container { padding: 16px 3vw 18px 3vw; }
            h1 { font-size: 1.4em; }
            .logo-icon { width: 36px; height: 36px; font-size: 1.4em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <div class="logo-icon">âš¡</div>
        </div>
        <h1>Ollama Bash Agent</h1>
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="flash">{{ messages[0] }}</div>
          {% endif %}
        {% endwith %}
        <form method="post" id="prompt-form">
            <select name="model" style="margin-bottom:8px; padding:7px; border-radius:6px; border:1px solid #3d465a; background:#232a3e; color:#e0e6f0; font-size:1em;">
                {% for m in models %}
                    <option value="{{ m }}" {% if model==m %}selected{% endif %}>{{ m }}</option>
                {% endfor %}
            </select>
            <input type="text" name="prompt" placeholder="Describe your task (e.g. list files in the current directory)" value="" autofocus required>
            {% if bash_command and not approved %}
                <button type="submit" name="approve" value="1">Approve & Run</button>
            {% else %}
                <button type="submit">Generate & Run</button>
            {% endif %}
            <div id="stream-output" style="background:#181f2e; color:#8aff80; padding:14px; border-radius:7px; margin-top:10px; min-height:28px; font-family:inherit; white-space:pre-wrap;"></div>
            <div id="loading-spinner" class="spinner"></div>
        </form>
        {% if bash_command %}
            <div class="command"><strong>Command:</strong> {{ bash_command }}</div>
        {% endif %}

        {% if error is defined and error and error|length > 0 %}
            <div class="flash">Error: {{ error }}</div>
        {% endif %}

        {% if output %}
            {% if steps and output %}
                <div class="output">
                    <strong>Step Outputs:</strong>
                    <ol style="margin:0; padding-left:1.2em;">
                    {% for o in output %}
                        <li style="margin-bottom:10px;">
                            <span style="color:#8aff80;"><strong>Command:</strong></span> <span style="color:#e0e6f0">{{ o.command }}</span><br>
                            <span style="color:#80c2ff;"><strong>Explanation:</strong></span> <span style="color:#e0e6f0">{{ o.explanation }}</span><br>
                            <span style="color:#ffd480;"><strong>Output:</strong></span> <span style="color:#e0e6f0">{{ o.output }}</span>
                        </li>
                    {% endfor %}
                    </ol>
                </div>
            {% else %}
                <div class="output"><strong>Output:</strong><br>{{ output }}</div>
            {% endif %}
            <form method="post" action="/download" style="margin-top:10px; text-align:right;">
                <input type="hidden" name="output" value="{{ output|tojson|safe }}">
                <button type="submit" style="padding:7px 13px; font-size:1em; background:#80c2ff; color:#232323; border:none; border-radius:5px; cursor:pointer;">Download Output</button>
            </form>
        {% endif %}
        {% if history %}
            <div style="margin-top:30px;">
                <h2 style="font-size:1.2em; color:#8aff80; border-bottom:1.5px solid #80c2ff; padding-bottom:4px;">History</h2>
                <div style="max-height:220px; overflow-y:auto;">
                {% for h in history|reverse %}
                    <div style="background:#232a3e; border-radius:7px; margin-bottom:10px; padding:10px 14px; box-shadow:0 1px 5px #0002;">
                        <div style="font-size:0.98em; color:#80c2ff;"><strong>Prompt:</strong> {{ h.prompt }}</div>
                        <div style="font-size:0.97em; color:#8aff80;"><strong>Command:</strong> {{ h.command }}</div>
                        <div style="font-size:0.97em; color:#e0e6f0;"><strong>Output:</strong> {{ h.output }}</div>
                        <div style="font-size:0.92em; color:#6b7687;"><strong>Model:</strong> {{ h.model }}</div>
                        <form method="post" style="display:inline;">
                            <input type="hidden" name="prompt" value="{{ h.prompt }}">
                            <input type="hidden" name="model" value="{{ h.model }}">
                            <button type="submit" style="margin-top:5px; padding:3px 8px; font-size:0.95em; background:#8aff80; color:#232323; border:none; border-radius:4px; cursor:pointer;">Replay</button>
                        </form>
                    </div>
                {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
    <footer>
        Ollama Bash Agent &middot; <span style="color:#8aff80">AI-Powered</span> &middot; &copy; 2025 Ivan Pinto
    </footer>
    <!-- First, inject the server variables -->
    <script type="text/javascript">
        // Set default values for injected variables
        window._injected = JSON.parse('{{ injected_data|tojson|safe }}') || {};
        let eventSource = null;
        let isProcessing = false;
        
        // Log page load
        console.log('[Ollama Bash Agent] Page loaded');
        console.log('Injected data:', window._injected);
        
        // Function to close existing connection
        function closeConnection() {
            if (eventSource) {
                try {
                    // Remove all event listeners first
                    eventSource.onopen = null;
                    eventSource.onmessage = null;
                    eventSource.onerror = null;
                    
                    // Close the connection
                    eventSource.close();
                    console.log('SSE connection closed');
                } catch (e) {
                    console.error('Error closing SSE connection:', e);
                } finally {
                    eventSource = null;
                    if (spinner) spinner.style.display = 'none';
                }
            }
        }
        
        // Define the streaming function
        function setupStreaming() {
            const form = document.getElementById('prompt-form');
            if (!form) {
                console.error('Prompt form not found');
                return;
            }
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Prevent multiple submissions
                if (isProcessing) {
                    console.log('Already processing a request');
                    return;
                }
                
                isProcessing = true;
                
                // Close any existing connection
                closeConnection();
                
                const form = e.target;
                const prompt = (form.prompt && form.prompt.value) || window._injected.prompt || '';
                const model = (form.model && form.model.value) || window._injected.model || 'llama3';
                const outputDiv = document.getElementById('stream-output');
                const spinner = document.getElementById('loading-spinner');

                if (!outputDiv) {
                    console.error('Output div not found');
                    isProcessing = false;
                    return;
                }
                
                outputDiv.textContent = '';
                if (spinner) spinner.style.display = 'inline-block';

                console.log('Connecting to SSE endpoint with prompt:', prompt, 'and model:', model);
                
                try {
                    // Create a unique URL to prevent caching issues
                    const url = `/stream?prompt=${encodeURIComponent(prompt)}&model=${encodeURIComponent(model)}&_=${Date.now()}`;
                    console.log('Connecting to SSE endpoint:', url);
                    
                    // Close any existing connection
                    closeConnection();
                    
                    // Create a new EventSource with error handling
                    try {
                        eventSource = new EventSource(url);
                        let receivedData = false;
                        let errorShown = false;
                        let lastEventId = '';
                        
                        // Handle connection opened
                        eventSource.onopen = function() {
                            console.log('SSE connection established');
                            if (spinner) spinner.style.display = 'inline-block';
                            if (outputDiv) outputDiv.textContent = '';
                        };
                        
                        // Handle incoming messages
                        eventSource.onmessage = function(event) {
                            try {
                                console.log('SSE raw message:', event);
                                
                                // Update last event ID for reconnection
                                if (event.lastEventId) {
                                    lastEventId = event.lastEventId;
                                }
                                
                                // Process the event data
                                if (event.data && event.data.trim()) {
                                    receivedData = true;
                                    
                                    // Handle different event types
                                    switch (event.type) {
                                        case 'status':
                                            console.log('Status update:', event.data);
                                            break;
                                            
                                        case 'error':
                                            console.error('Server error:', event.data);
                                            if (outputDiv) {
                                                outputDiv.textContent += `\n[Error] ${event.data}\n`;
                                                outputDiv.scrollTop = outputDiv.scrollHeight;
                                            }
                                            break;
                                            
                                        case 'end':
                                            console.log('Stream ended');
                                            closeConnection();
                                            break;
                                            
                                        default:  // 'message' or unspecified
                                            if (outputDiv) {
                                                outputDiv.textContent += event.data;
                                                outputDiv.scrollTop = outputDiv.scrollHeight;
                                            }
                                    }
                                }
                                
                            } catch (e) {
                                console.error('Error processing SSE message:', e);
                            } finally {
                                if (spinner) spinner.style.display = 'none';
                            }
                        };

                        // Handle connection errors
                        eventSource.onerror = function(error) {
                            console.error('SSE connection error:', error);
                            
                            // Only show error if we haven't received any data yet
                            if (!receivedData && !errorShown) {
                                if (outputDiv) {
                                    outputDiv.textContent = 'Error: Could not connect to the server. ';
                                    outputDiv.textContent += 'Please check if the Ollama service is running and try again.';
                                    outputDiv.scrollTop = outputDiv.scrollHeight;
                                }
                                errorShown = true;
                            }
                            
                            // Close the connection on error
                            closeConnection();
                            if (spinner) spinner.style.display = 'none';
                        };
                        
                        // Handle specific event types
                        eventSource.addEventListener('status', function(e) {
                            console.log('Status:', e.data);
                        });
                        
                        eventSource.addEventListener('error', function(e) {
                            console.error('Server error event:', e.data);
                            if (outputDiv) {
                                outputDiv.textContent += `\n[Server Error] ${e.data}\n`;
                                outputDiv.scrollTop = outputDiv.scrollHeight;
                            }
                        });
                        
                        eventSource.addEventListener('end', function() {
                            console.log('Received end event');
                            closeConnection();
                        });
                        
                        // Set a timeout to close the connection if no data is received
                        const connectionTimeout = setTimeout(() => {
                            if (!receivedData && eventSource.readyState !== EventSource.CLOSED) {
                                console.error('SSE connection timeout');
                                if (outputDiv) {
                                    outputDiv.textContent = 'Error: Connection timed out. The server is taking too long to respond.';
                                    outputDiv.scrollTop = outputDiv.scrollHeight;
                                }
                                closeConnection();
                                if (spinner) spinner.style.display = 'none';
                            }
                        }, 30000); // 30 seconds timeout
                        
                        // Clean up the timeout when data is received
                        eventSource.addEventListener('message', function cleanup() {
                            clearTimeout(connectionTimeout);
                            eventSource.removeEventListener('message', cleanup);
                        });
                        
                    } catch (e) {
                        console.error('Error creating EventSource:', e);
                        if (outputDiv) {
                            outputDiv.textContent = 'Error: Failed to create a connection to the server.';
                            outputDiv.scrollTop = outputDiv.scrollHeight;
                        }
                        if (spinner) spinner.style.display = 'none';
                    }

                } catch (error) {
                    console.error('Error creating EventSource:', error);
                    if (spinner) spinner.style.display = 'none';
                    if (outputDiv) {
                        outputDiv.textContent = 'Error: Could not establish connection to the server.';
                    }
                    closeConnection();
                }
            });
            
            // Clean up on page unload
            window.addEventListener('beforeunload', closeConnection);
        }
        
        // Initialize when the DOM is fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupStreaming);
        } else {
            setupStreaming();
        }
    </script>
    
    <!-- Then load the rest of the JavaScript files -->
    <script src="/static/injected_vars.js"></script>
    <script src="/static/main.js"></script>
</body>
</html>
